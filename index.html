<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vào Phòng Thi | Hệ thống Thi Trực Tuyến</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="assets/js/api-connector.js"></script>
</head>
<body>

    <div class="login-container">
        <div style="margin-bottom: 20px; color: #4a90e2;">
            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path d="M12 14l9-5-9-5-9 5 9 5z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>

        <h2>HỆ THỐNG THI TRỰC TUYẾN</h2>
        <p class="sub-title">Trường THPT Phan Bội Châu</p>

        <div class="login-form">
            <div class="form-group">
                <label for="student-name">Họ và Tên</label>
                <div class="input-wrapper">
                    <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <input type="text" id="student-name" placeholder="Nhập họ và tên..." autocomplete="off">
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;"> <div class="form-group" style="flex: 1 1 45%;"> <label for="class-id">Lớp</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        <input type="text" id="class-id" placeholder="12A..." oninput="this.value = this.value.toUpperCase()">
                    </div>
                </div>

                <div class="form-group" style="flex: 1 1 45%;"> <label for="exam-id">Mã Đề</label>
                    <div class="input-wrapper">
                        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 17h.01M9 20h.01M5 8h.01M9 8h.01M5 12h.01M19 8h.01M15 12h.01M5 16h.01" />
                        </svg>
                        <input type="text" id="exam-id" placeholder="CODE" oninput="this.value = this.value.toUpperCase()">
                    </div>
                </div>
            </div>

            <div class="form-group hidden" id="late-code-group" style="display: none;">
                <label for="late-code" style="color: #e67e22;">⚠️ Mã xác nhận vào muộn</label>
                <div class="input-wrapper">
                     <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <input type="number" id="late-code" placeholder="Nhập mã...">
                </div>
            </div>

            <button id="login-btn" class="btn">VÀO PHÒNG THI</button>

            <a href="https://hxhung.github.io/web-trac-nghiem/" class="home-btn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Quay về Trang Chủ
            </a>

            <div id="error-msg" class="message error"></div>
            <div id="success-msg" class="message success"></div>
        </div>

        <div class="footer">
            &copy; 2026 MathMaster System <br> Phát triển bởi hxhung
        </div>
    </div>

    <script>
        const ui = {
            btn: document.getElementById('login-btn'),
            err: document.getElementById('error-msg'),
            suc: document.getElementById('success-msg'),
            late: document.getElementById('late-code-group'),
            lateCode: document.getElementById('late-code')
        };

        function error(msg) {
            ui.err.innerHTML = msg; ui.err.style.display = 'block'; ui.suc.style.display = 'none';
            ui.btn.disabled = false; ui.btn.innerHTML = 'VÀO PHÒNG THI';
            document.querySelector('.login-container').animate([
                { transform: 'translateX(0)' }, { transform: 'translateX(-5px)' }, 
                { transform: 'translateX(5px)' }, { transform: 'translateX(0)' }
            ], { duration: 300 });
        }

        function success(msg) {
            ui.suc.innerText = msg; ui.suc.style.display = 'block'; ui.err.style.display = 'none';
            ui.btn.innerHTML = '<div class="spinner"></div> Đang chuyển hướng...';
        }

        ui.btn.addEventListener('click', async () => {
            const name = document.getElementById('student-name').value.trim();
            const cls = document.getElementById('class-id').value.trim();
            const eid = document.getElementById('exam-id').value.trim();

            if (!name || name.length < 2) return error('Vui lòng nhập họ tên hợp lệ');
            if (!cls) return error('Vui lòng nhập tên lớp');
            if (!eid) return error('Vui lòng nhập mã đề thi');
            if (typeof checkExamAccess !== 'function') return error('Lỗi API (Chưa load script)');

            ui.btn.disabled = true; ui.btn.innerHTML = '<div class="spinner"></div> Đang kiểm tra...';

            try {
                const acc = await checkExamAccess(eid, ui.lateCode.value.trim());
                if (!acc.success) {
                    error(acc.message || 'Không thể truy cập đề');
                    if (acc.status === 'REQUIRE_CODE') { ui.late.style.display = 'block'; ui.lateCode.focus(); }
                    return;
                }
                const q = await getQuestions(eid);
                if (!q.success) return error('Lỗi tải câu hỏi');

                sessionStorage.setItem('currentExam', JSON.stringify({
                    examId: eid, title: acc.title, duration: acc.duration,
                    studentName: name, studentClass: cls, questions: q.data, startToken: Date.now()
                }));

                success('Đăng nhập thành công!');
                setTimeout(() => location.href = 'exam.html', 1000);
            } catch (e) { console.error(e); error('Lỗi: ' + e.message); }
        });
    </script>
</body>
</html>