<!DOCTYPE html - ver 1.10>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Vào Phòng Thi | Hệ thống Thi Trực Tuyến</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Hệ thống thi trực tuyến môn Toán THPT">
    
    <link rel="stylesheet" href="css/style.css">

    <script src="assets/js/api-connector.js"></script>
</head>
<body>

    <div class="login-container">
        <h2>HỆ THỐNG THI TRỰC TUYẾN</h2>
        <p style="color: #666; margin-bottom: 20px;">Trường THPT Phan Bội Châu</p>

        <div class="login-form">
            <div class="form-group">
                <label for="student-name">Họ và Tên</label>
                <input type="text" id="student-name" placeholder="Nhập đầy đủ họ tên..." autocomplete="off">
            </div>

            <div class="form-group">
                <label for="class-id">Lớp</label>
                <input type="text" id="class-id" placeholder="Ví dụ: 12C12" oninput="this.value = this.value.toUpperCase()">
            </div>

            <div class="form-group">
                <label for="exam-id">Mã Đề Thi</label>
                <input type="text" id="exam-id" placeholder="Nhập mã đề giáo viên cung cấp" oninput="this.value = this.value.toUpperCase()">
            </div>

            <div class="form-group hidden" id="late-code-group" style="display: none;">
                <label for="late-code" style="color: #e67e22;">⚠️ Mã xác nhận vào muộn</label>
                <input type="number" id="late-code" placeholder="Nhập mã do giám thị cấp">
            </div>

            <button id="login-btn" class="btn">VÀO PHÒNG THI</button>
            
            <div id="error-msg" class="message error"></div>
            <div id="success-msg" class="message success"></div>
        </div>

        <div class="footer">
            &copy; 2026 MathMaster System <br> Phát triển bởi Tổ Toán - Tin
        </div>
    </div>

    <script>
        // Các hàm tiện ích hiển thị thông báo
        const ui = {
            btn: document.getElementById('login-btn'),
            err: document.getElementById('error-msg'),
            suc: document.getElementById('success-msg'),
            late: document.getElementById('late-code-group'),
            lateCode: document.getElementById('late-code')
        };

        function error(msg) {
            ui.err.innerText = msg;
            ui.err.style.display = 'block';
            ui.suc.style.display = 'none';
            ui.btn.disabled = false;
            ui.btn.innerHTML = 'VÀO PHÒNG THI';
            
            // Hiệu ứng rung lắc báo lỗi
            const container = document.querySelector('.login-container');
            container.classList.add('shake');
            setTimeout(() => container.classList.remove('shake'), 500);
        }

        function success(msg) {
            ui.suc.innerText = msg;
            ui.suc.style.display = 'block';
            ui.err.style.display = 'none';
            ui.btn.innerHTML = '<div class="spinner"></div> Đang chuyển hướng...';
        }

        // Xử lý sự kiện Click nút đăng nhập
        ui.btn.addEventListener('click', async () => {
            const name = document.getElementById('student-name').value.trim();
            const cls = document.getElementById('class-id').value.trim();
            const eid = document.getElementById('exam-id').value.trim();

            // Validate dữ liệu
            if (!name || name.length < 2) return error('Vui lòng nhập họ tên hợp lệ');
            if (!cls) return error('Vui lòng nhập tên lớp');
            if (!eid) return error('Vui lòng nhập mã đề thi');
            
            // Kiểm tra API Connector
            if (typeof checkExamAccess !== 'function') return error('Lỗi kết nối hệ thống (API Missing)');

            ui.btn.disabled = true;
            ui.btn.innerHTML = '<div class="spinner"></div> Đang kiểm tra...';

            try {
                // 1. Kiểm tra quyền truy cập (Check Access)
                const acc = await checkExamAccess(eid, ui.lateCode.value.trim());
                
                if (!acc.success) {
                    error(acc.message || 'Không thể truy cập đề');
                    // Nếu server báo cần mã vào muộn -> Hiện ô nhập
                    if (acc.status === 'REQUIRE_CODE') {
                        ui.late.style.display = 'block';
                        ui.lateCode.focus();
                    }
                    return;
                }

                // 2. Tải đề thi (Get Questions)
                const q = await getQuestions(eid);
                if (!q.success) return error('Mã đề đúng nhưng không tải được câu hỏi.');

                // 3. Lưu dữ liệu vào Session và chuyển trang
                sessionStorage.setItem('currentExam', JSON.stringify({
                    examId: eid,
                    title: acc.title,
                    duration: acc.duration,
                    studentName: name,
                    studentClass: cls,
                    questions: q.data,
                    startToken: Date.now()
                }));

                success('Đăng nhập thành công!');
                
                // Chuyển trang sau 1s
                setTimeout(() => location.href = 'exam.html', 1000);

            } catch (e) {
                console.error(e);
                error('Lỗi hệ thống: ' + e.message);
            }
        });
        
        // Thêm CSS hiệu ứng rung lắc khi lỗi
        const styleShake = document.createElement('style');
        styleShake.innerHTML = `
            .shake { animation: shake 0.5s; }
            @keyframes shake {
                0% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                50% { transform: translateX(5px); }
                75% { transform: translateX(-5px); }
                100% { transform: translateX(0); }
            }
        `;
        document.head.appendChild(styleShake);
    </script>
</body>
</html>